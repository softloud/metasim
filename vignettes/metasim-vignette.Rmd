---
title: "metasim package"
author: "Charles T. Gray"
date: "`r Sys.Date()`"
bibliography: biblio.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  fig.width = 7,
  fig.height = 5,
  cache = TRUE,
  collapse = TRUE,
  comment = "#>"
)
```

# vignette text

## preamble

```{r packages}
library(metasim)
library(tidyverse)
```

## introduction

`metasim::` rather ambitiously attempts to lower the programmatic barrier to running simulation experiments for meta-analysts. The intended audience of this package are practicing scientists who wish to experiment to see how their chosen estimator works but who are not necessarily computational mathematicians. 

Frequently, scientists wish to verify their results, and, in particular, that the broad findings hold for their particular context. For example, perhaps an estimator works well for some sample sizes and not others?


Consider - todo: use an example from Bland [@bland_estimating_2014] comparison paper <performs well for some sample sizes and not others>. 

In the first application of the `metasim::` package meta-analysis of medians, the goal is to reduce the amount of code for reproducibility and accessibility. Given a comparison was required, there is a high risk of repetative code. And this, too, creates a barrier for scientists whose primary discipline is not programming. The more lines of repeated code, the more likely a small mistake will cause the entire analysis algorithm to grind to a halt. This is not insurmountable, but it _is_ time consuming. Frequently the code was functional at the time of publication, but in the meantime the author has made some small change in the code and it no longer runs without debugging. This package aims to assist in smoothing the inevitable debugging process that accompanies the simulation of meta-analysis data. 

### opinionated bit 

todo: not sure where this section goes

This package is an _opinionated_ algorithm [@parker_opinionated_2017], in that  todo: 

By integrating the output of the results  todo: 

Consider - three starting papers [@bland_estimating_2014; @hozo_estimating_2005; @wan_estimating_2014] + example dataset [@pinheiro_d-dimer_2012] of motivating problem, these were not written by statisticians. Thus, it's okay for software to be opionated. And indeed, we must, as methodologists, make necessary choices about presentation and implementation that carry the value judgement of opinion. There are often multiple ways to solve a problem, and it is not always helpful to provide all possible solutions. Often the end-user wishes to find a useful guide. 

todo: sweet spot between clippy-like interfaces and hard code (say, traversing the CRAN guidebook thingies that I've never even looked at for meta-analysis) - indeed, this is what the meta-verse aims to do...


## the package in a glance

An advantage with standardised results, whatever they may be 


## some maths

## some maths

## applications

### meta-analysis of medians

The `metasim::` package began as a script to solve this particular problem, and so it is currently the default simulation parameter set for `metasims()`.


#### the problem


#### simulation parameters

In order to compare the performance of the estimator, we wished to consider a number of different contraints. 

```{r simulation parameters}
metasims_args <- args(metasims) %>% as.list()
metasims_args %>% names()
```

- $k =$ `r metasims_args %>% pluck("k") %>% eval()` studies
- $\tau^2 =$ `r metasims_args %>% pluck("tau2_true") %>% eval()` variation between studies
- constrain the smallest and largest size sample, from `r metasims_args$min_n` , to  `r metasims_args$max_n`.
- compare how the estimator performs for whether there is no difference, between the control and intervention group, of the two measures of interest, and when there is; with the ratio of effects $\rho = \nu_I / \nu_C =$ `r metasims_args$effect_ratio %>% eval()` 
- sample from symmetric (normal distribution) and assymmetric (log-normal, exponential) underlying distributions, from any number of a parameter sets. 
- the expected proportion the intervention group, defaulting to `r metasims_args$prop` and what difference from the `r metasims_args$prop_error`   difference 90% of other proportions fall within.   

There is scope to extend the number of distributions in future releases of `metasim::`. Furthermore, the question of the best selection of parameter remains for future work. For example, incorporating elements from experimental design [@pardalos_sampling_2016] into the construction of the simulation parameter set.        

A set of default parameters is exported as a data object `default_parameters` in `metasim::`.

```{r}
default_parameters %>% knitr::kable()
```

#### default distributions

```{r echo=FALSE}
metasim::default_parameters %>% 
  uncount(weights = 50, .id = "x") %>%
  mutate(
    x = x / 10,
    y = pmap_dbl(
    list(
      x = x,
      dist = dist,
      par = par
    ), .f = function(x, dist, par) {
      if (dist == "pareto") actuar::dpareto2(x, par[[1]], par[[2]])
      else density_fn(x, distribution = dist, parameters = par, type = "d")
    }
  ),
  density = map2_chr(dist, par, .f = function(x,y) {
    paste(dist_name(x), paste(y, collapse = ", "))
  })) %>% 
  mutate(distribution = map_chr(dist, dist_name)) %>% 
  ggplot(aes(x = x, y = y)) +
  geom_line(aes(group = density, 
                linetype = density,
                colour = distribution)) +
  hrbrthemes::scale_color_ipsum() +
  facet_grid(distribution ~ ., scales = "free") +
  labs(title = "Distributions sampled",
       x = NULL,
       y = "density")  



```



#### ratio plots

#### single-study simulation

```{r echo=FALSE}


measure = "median"
distributions = default_parameters 
cap_width = 110

caption_distributions <- distributions %>% 
  mutate(distribution = map_chr(dist, dist_name),
  output = paste0("the ", distribution, 
                  " distribution, with parameters "),
  par_count = map_int(par, length),
  par_1 = map_dbl(par, 1),
  par_2 = map(par, 2),
  output = case_when(
    par_count == 1 ~ paste0(output, par_1),
    par_count == 2 ~ paste0(output, par_1, " and ", par_2)
   )) %>% pluck("output") %>% paste(., collapse = ", ")

single_sim_caption <- paste0(
  "Simulation results for the number of confidence intervals 
  that contain the true measure of interest, the ",
  measure, 
  " and, log-ratio of the control ",
  measure, 
  " with intervention ",
  measure,
  ". The case where the control ",
  measure, 
  " is equal to the intervention ",
  measure, 
  " is considered, as is unequal ratio = ",
  metasims_args$effect_ratio %>% eval() %>% paste(collapse = ","),
  ". The distributions considered were ",
  caption_distributions,
  "."
)

```


```{r echo=FALSE}
single_sim <- metasims(
  progress = FALSE, 
  single_study = TRUE)

# generate a caption
single_sim %>%
  mutate(distribution = map_chr(rdist, dist_name)) %>%
  ggplot(aes(x = distribution, y = coverage)) +
  geom_point(
         position = "jitter",
         aes(colour = distribution, shape = as.character(effect_ratio)),
         alpha = 0.8,
         size = 3
       ) +
  scale_shape_discrete(name = "Effect ratio") +
  hrbrthemes::scale_colour_ipsum(name = "Distribution") +
  labs(
    x = "Distribution",
       y = "Coverage",
    title = str_wrap(
      "Simulation results for estimating the variance of the sample median"
    ),
    caption = single_sim_caption %>% str_wrap(width = cap_width)
  ) + theme(
    axis.text.x = element_text(
      angle = 35,
      hjust = 1,
      vjust = 1
    ),
    plot.caption = element_text(hjust = 0, margin = margin(t = 10))
  ) 


```


#### meta-analysis simulation


```{r meta analysis plot, echo=FALSE}
meta_sim <- metasims(
  progress = FALSE, 
  single_study = FALSE)



```

```{r echo=FALSE}
meta_sim_caption <- paste0(
  single_sim_caption, " Different numbers of studies were considered, ",
  metasims_args$k %>% eval() %>% paste(collapse = ", "),
  ", in the vertical facets of the plot; and values for the variation between studies, ",
  metasims_args$tau2_true %>% eval() %>% paste(collapse = ", "),
  " in the horizontal facets of the plot."
)


meta_sim %>% 
  mutate(distribution = map_chr(rdist, dist_name)) %>% 
     ggplot(aes(x = distribution, y = coverage)) +
    theme(axis.text.x = element_text(angle = 35, hjust = 1),
          plot.caption = element_text(hjust = 0)) +
    labs(x = "Distribution",
         y = "Coverage"
        )  +  geom_point(position = "jitter",
      aes(colour = distribution, shape = as.character(effect_ratio)),
      alpha = 0.6, size = 3) +
  facet_grid(tau2_true ~ k) +
  scale_shape_discrete(name = "Effect ratio") +
  hrbrthemes::scale_colour_ipsum(name = "Distribution") +
  labs(title = str_wrap("Simulated meta-analysis results for estimating the variance of the median"),
       caption = meta_sim_caption %>% str_wrap(width = cap_width))

```


## references


